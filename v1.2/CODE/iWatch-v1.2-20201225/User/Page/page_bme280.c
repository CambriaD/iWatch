#include "iWatch.h"

extern unsigned char xdata main_cache[];
extern unsigned char xdata sub_cache[];

static PageExecuteRate_TypeDef Rate_50hz = {20, 0};

static unsigned char code Text[] = "BME280";
static unsigned char code Icon[] = {
0x00,0x00,0x00,0x00,0x00,0xE0,0x70,0x10,0x18,0x18,0x18,0x10,0x70,0xE0,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x60,0xC0,0x80,0x00,0x08,0xB8,0x80,0x80,0xC0,
0xDF,0xCE,0xC0,0x80,0x90,0x38,0x08,0x00,0xC0,0xE0,0x70,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0x98,0x98,0x18,0x18,0x18,0x00,0x00,0xFF,0xFF,0x00,
0x00,0x00,0xC0,0xC0,0xC4,0xC4,0x0C,0x00,0xF0,0xFC,0x0E,0x03,0x01,0x01,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0E,0xF8,0xE0,0x04,0x8C,0xC6,0xC0,0xC0,0x80,
0x00,0x00,0x00,0x00,0xFF,0xFF,0x73,0x73,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,
0x00,0x00,0x00,0x00,0x18,0x18,0x08,0x80,0xC3,0x8F,0x18,0x30,0x60,0x40,0xC0,0xC0,
0xC0,0xC0,0xC0,0xC0,0x60,0x60,0x30,0x1C,0xCF,0x81,0x08,0x08,0x18,0x00,0x00,0x00,
0x00,0x00,0x00,0x80,0xFF,0x7F,0x0E,0x0E,0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,0x80,
0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x01,0x00,0x00,0x0C,0x0E,0x00,0x00,0x00,
0x3C,0x3C,0x00,0x00,0x02,0x0E,0x00,0x00,0x00,0x01,0x03,0x02,0x00,0x00,0x00,0x00,
0xF0,0xFE,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x40,0x01,
0x03,0x1E,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x07,0x1C,0x30,0x20,0x60,0x40,0xC0,0xC0,0xC4,0xC4,0xC6,0x43,0x61,0x60,0x30,
0x1C,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
/* (48 X 48 )*/
};

const unsigned char code T_H_P_A[] = {			//48x64温度显示界面的中文
	0x10,0x60,0x02,0x8C,0x00,0x00,0xFE,0x92,0x92,0x92,0x92,0x92,0xFE,0x00,0x00,0x00,
	0x00,0x00,0xFC,0x24,0x24,0x24,0xFC,0x25,0x26,0x24,0xFC,0x24,0x24,0x24,0x04,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x04,0x04,0x7E,0x01,0x40,0x7E,0x42,0x42,0x7E,0x42,0x7E,0x42,0x42,0x7E,0x40,0x00,
	0x40,0x30,0x8F,0x80,0x84,0x4C,0x55,0x25,0x25,0x25,0x55,0x4C,0x80,0x80,0x80,0x00,
	0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x10,0x60,0x02,0x8C,0x00,0xFE,0x92,0x92,0x92,0x92,0x92,0x92,0xFE,0x00,0x00,0x00,
	0x00,0x00,0xFC,0x24,0x24,0x24,0xFC,0x25,0x26,0x24,0xFC,0x24,0x24,0x24,0x04,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x04,0x04,0x7E,0x01,0x44,0x48,0x50,0x7F,0x40,0x40,0x7F,0x50,0x48,0x44,0x40,0x00,
	0x40,0x30,0x8F,0x80,0x84,0x4C,0x55,0x25,0x25,0x25,0x55,0x4C,0x80,0x80,0x80,0x00,
	0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x20,0x10,0x4C,0x47,0x54,0x54,0x54,0x54,0x54,0x54,0x54,0xD4,0x04,0x04,0x00,0x00,
	0x00,0x00,0xFE,0x02,0x82,0x82,0x82,0x82,0xFA,0x82,0x82,0x82,0x82,0x82,0x02,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x30,0x40,0xF0,0x00,
	0x80,0x60,0x1F,0x40,0x40,0x40,0x40,0x40,0x7F,0x40,0x40,0x44,0x58,0x40,0x40,0x00,
	0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x10,0x60,0x02,0x0C,0xC0,0x10,0x08,0xF7,0x14,0x54,0x94,0x14,0xF4,0x04,0x00,0x00,
	0x10,0x10,0x10,0xFF,0x90,0x40,0x10,0x10,0xF0,0x9F,0x90,0x91,0x96,0x90,0x10,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x04,0x04,0x7C,0x03,0x00,0x01,0x1D,0x13,0x11,0x55,0x99,0x51,0x3F,0x11,0x01,0x00,
	0x02,0x42,0x81,0x7F,0x00,0x40,0x30,0x8F,0x80,0x43,0x2C,0x10,0x2C,0x43,0x80,0x00,
	0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const unsigned char code CELSIUS_ICON[] = {	//16x16温度显示界面的摄氏度符号
	0x00,0x00,0x38,0x44,0x44,0x38,0xE0,0x18,0x08,0x04,0x04,0x04,0x08,0x10,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x30,0x60,0x40,0x40,0x40,0x20,0x10,0x00,0x00
};
struct bme280_data BME280;			//bme280数据结构体
float altitude;
unsigned char str1[10] = {0};
/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup()
{
	ClearCache(sub_cache);
	BMPToCache(0, 0, 48, 64, T_H_P_A, sub_cache, 0);
	PageOpenAnim(ANIM_RIGHT);
	BME280ContinuousMeasurement(MS_125);		//连续测量模式，测量间隔125ms
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit()
{
	BME280SetMode(SLEEP_MODE);
	PageCloseAnim(ANIM_RIGHT);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	if(PageExecuteRate(&Rate_50hz) == 1)
	{
		BME280GetSensorData(&BME280);					//读BME280测量数据并显示
		altitude = 44330.77 * (1 - pow((BME280.pressure / 101500), 0.190263));
		ClearCache(main_cache);
		BMPToCache(0, 0, 48, 64, T_H_P_A, main_cache, 0);
		sprintf(str1, "%.1f", BME280.temperature);
		ShowString(48, 0, str1, main_cache, FONT8X16, NO_INVERSED);
		BMPToCache(84, 0, 16, 16, CELSIUS_ICON, main_cache, 0);
		sprintf(str1, "%.1f %%", BME280.humidity);
		ShowString(48, 2, str1, main_cache, FONT8X16, NO_INVERSED);
		sprintf(str1, "%ld Pa", (long)BME280.pressure);
		ShowString(48, 4, str1, main_cache, FONT8X16, NO_INVERSED);
		sprintf(str1, "%d m", (int)altitude);
		ShowString(48, 6, str1, main_cache, FONT8X16, NO_INVERSED);
		ScreenRefreshAll(main_cache);
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY1)
		PageShift(page_menu);
}

void PageRegister_page_bme280(unsigned char pageID)
{
	PageRegister(pageID, Text, Icon, Setup, Loop, Exit, Event);
}