#include "iWatch.h"

extern unsigned char xdata main_cache[];
extern unsigned char xdata sub_cache[];

unsigned char xdata cache_watch[1024] = {0};	//一段显存，用来保存时钟界面

static PageExecuteRate_TypeDef Rate_50hz = {20,0};

unsigned char code WEEKDAY_IN_STR[7][6] = {
	"Mon. \0",
	"Tues.\0",
	"Wed. \0",
	"Thur.\0",
	"Fri. \0",
	"Sat. \0",
	"Sun. \0"
};
unsigned char code BATTERY_LIFE_ICON[] = {//24x8
	0xFF,0x81,0x81,0x81,0x81,0x81,0x81,0x81,
	0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81,
	0x81,0x81,0x81,0x81,0x81,0xFF,0x3C,0x3C
};
void DisplayTime(unsigned char hour, unsigned char min, unsigned char sec);
extern iWatch_config config;
extern pcf8563_time time;		//时间信息结构体
extern float battery_life;  			//电池电量
unsigned char battery[24];
void SaveWatch(void)
{
	unsigned int data n;
	for(n = 0; n < 1024; n++)
		cache_watch[n] = main_cache[n];
}
/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup()
{
	unsigned int data n;
	for(n = 0; n < 1024; n++)
		sub_cache[n] = cache_watch[n];
	PageOpenAnim(1);
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit()
{
	SaveWatch();
	PageCloseAnim(0);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	unsigned char n, m;
	unsigned char str[16];
	if(PageExecuteRate(&Rate_50hz) == 1)
	{
		//显示时间
		PCF8563ReadTime(&time);
		DisplayTime(time.hour, time.minute, time.second);
		//显示小图标
		/*
		ClearCacheArea(0, 0, 35, 8, main_cache);
		x = 0;
		BMPToCache(x, 0, 8, 8, BLUETOOTH_SMALL_ICON, main_cache, 0);
		x += 9;
		if(timer_on_flag)
		{
			BMPToCache(x, 0, 8, 8, TIMER_SMALL_ICON, main_cache, 0);
			x += 9;
		}
		if(config.alarm_mode != ALARM_DISABLE)
		{
			BMPToCache(x, 0, 8, 8, CLOCK_SMALL_ICON, main_cache, 0);
			x += 9;
		}
		*/
		//显示日期，星期
		ClearCacheArea(0, 7, 128, 8, main_cache);
		sprintf(str, "%d/%d/%d ", (int)time.year + 2000, (int)time.month, (int)time.day);
		strcat(str, WEEKDAY_IN_STR[time.weekday - 1]);
		ShowString(0, 7, str, main_cache, FONT6X8, NO_INVERSED);
		//显示电量
		battery_life = iWatchGetBatteryLife();
		for(n = 0; n < 24; n++)
			battery[n] = BATTERY_LIFE_ICON[n];
		m = 18 * battery_life;
		for(n = 2; n < 2 + m; n++)
			battery[n] |= 0x3c;
		BMPToCache(104, 0, 24, 8, battery, main_cache, 0);
		sprintf(str, "%3d%%", (int)(battery_life * 100));
		ShowString(78, 0, str, main_cache, FONT6X8, NO_INVERSED);
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY2)
		PageShift(page_menu);
	else if(event == KEY1)
		iWatchSleep();
}

void PageRegister_page_watch(unsigned char pageID)
{
	PageRegister(pageID, 0, 0, Setup, Loop, Exit, Event);
}
/****************************************16*48的点阵************************************/
/******************************************数字0~9**************************************/
const unsigned char code F16X48[11][96] = /* (16 X 48 , Tahoma, 加粗 )*/
{
	{
		0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,0x00,
		0xE0,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x01,0x03,0x1F,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x07,0xFF,0xFF,0xFF,0xFF,0xF8,0xC0,0x80,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0x07,0x00,
		0x00,0x00,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x07,0x00,0x00,0x00/*"0",0*/
	},
	{
		0x00,0x00,0x00,0x00,0x80,0xC0,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x7F,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0x00,
		0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x00/*"1",1*/
	},
	{
		0x00,0xF8,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xFC,0xF8,0xE0,0x00,0x00,0x00,
		0x00,0x1F,0x0F,0x07,0x03,0x03,0x03,0x07,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFE,0xFF,0xFF,0x7F,0x0F,0x01,0x00,0x00,0x00,
		0x00,0xC0,0xF0,0xFC,0xFF,0xFF,0xFF,0xDF,0xC7,0xC1,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,
		0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x00/*"2",2*/
	},
	{
		0x00,0xF8,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xF0,0x80,0x00,0x00,
		0x00,0x1F,0x0F,0x07,0x03,0x03,0x03,0x03,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
		0x00,0x00,0x00,0x00,0xF8,0xF8,0xF8,0xFC,0xFE,0xFF,0xFF,0xBF,0x0F,0x01,0x00,0x00,
		0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x07,0x0F,0x1F,0xFF,0xFF,0xFF,0xFE,0xF0,0x00,
		0xF8,0xF0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0xE0,0xF0,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x1F,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x3F,0x1F,0x0F,0x03,0x00,0x00/*"3",3*/
	},
	{
		0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
		0x00,0x80,0xF0,0xFF,0xFF,0x3F,0x03,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
		0xFC,0xFF,0xFF,0xFF,0xF1,0xF0,0xF0,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0xF0,0xF0,
		0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x0F,0x0F,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x00,0x00,0x00/*"4",4*/
	},
	{
		0x00,0x00,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,
		0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,
		0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xFC,0xFC,0xFC,0xF8,0xF0,0xC0,0x00,0x00,
		0x00,0x00,0x07,0x07,0x03,0x03,0x03,0x03,0x07,0x0F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,
		0x00,0xF8,0xF0,0xE0,0xC0,0xC0,0xC0,0xC0,0xE0,0xF8,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x00,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x01,0x00,0x00/*"5",5*/
	},
	{
		0x00,0x00,0x80,0xE0,0xF0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0x00,0x00,0x00,
		0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x0F,0x03,0x01,0x01,0x01,0x01,0x03,0x00,0x00,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x01,0x01,0x03,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x07,0xFF,0xFF,0xFF,0xFF,0xF8,0xC0,0x80,0x80,0xE0,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x00,0x00,0x07,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x01,0x00,0x00/*"6",6*/
	},
	{
		0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,
		0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xC3,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0xFF,0xFF,0xFF,0xFF,0x1F,0x01,0x00,0x00,
		0x00,0x00,0x00,0x00,0x80,0xF8,0xFF,0xFF,0xFF,0xFF,0x3F,0x03,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x30,0x3F,0x3F,0x3F,0x3F,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00/*"7",7*/
	},
	{
		0x00,0x00,0xE0,0xF8,0xFC,0xFC,0xFE,0xFE,0xFE,0xFE,0xFC,0xFC,0xF8,0xE0,0x80,0x00,
		0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x01,0x01,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x00,0x07,0x3F,0xFF,0xFF,0xFF,0xFF,0xFC,0xF8,0xFC,0xFF,0xFF,0x1F,0x07,0x00,0x00,
		0xE0,0xFC,0xFE,0xFF,0xFF,0x0F,0x07,0x0F,0x1F,0x3F,0xFF,0xFF,0xFF,0xFE,0xF0,0x00,
		0x7F,0xFF,0xFF,0xFF,0xFF,0xE0,0xC0,0x80,0x80,0xE0,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,
		0x00,0x07,0x0F,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x03,0x00,0x00/*"8",8*/
	},
	{
		0x00,0x80,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x80,0x00,0x00,
		0xF8,0xFF,0xFF,0xFF,0xFF,0x0F,0x01,0x01,0x03,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0xC0,0x80,0x80,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x00,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,
		0x00,0x00,0xC0,0x80,0x80,0x80,0x80,0xC0,0xF0,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,
		0x00,0x00,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x07,0x00,0x00,0x00,0x00/*"9",9*/
	},
	{	
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00/*":",10*/
	}
};
/**
	* @brief 	在主显存上显示时间，并实现时间变动时的动态效果
	*					当这次传入参数和上次调用该函数的参数不同时，不同的那位数字会动态切换
	*					其他相同的位数字不任何处理
	* @param  hour：小时，min：分钟，sec：秒钟
	* @retval 无
	*/
void DisplayTime(unsigned char hour, unsigned char min, unsigned char sec)
{
	char n; 
	unsigned char idata i, j, num3;
	unsigned int idata k, num1, num2, temp;
	unsigned char buf[8];
	static unsigned char idata last_buf[8] = {11,11,11,11,11,11,11,11};
	buf[0] = hour / 10;
	buf[1] = hour % 10;
	buf[2] = 10;
	buf[3] = min / 10;
	buf[4] = min % 10;
	buf[5] = 10;
	buf[6] = sec / 10;
	buf[7] = sec % 10;
	for(n = 7; n  >= 0; n--)
	{
		if(buf[n] != last_buf[n])
		{
			for(i = 0; i < 48; i++)
			{
				for(j = 0; j < 5; j ++)
				{
					num1 = (j + 1) * 128 + n * 16;
					num2 = num1 + 16;
					for(k = num1; k < num2; k++)
					{
						temp = (main_cache[k + 128] << 8) | main_cache[k];
						main_cache[k] = (temp >> 1);
					}
				}
				num1 = (j + 1) * 128 + n * 16;
				num2 = (i / 8) * 16;
				num3 = 7 - i % 8;
				for(k = 0; k < 16; k++)	
				{
					main_cache[k + num1] =  (main_cache[k + num1] >> 1) | ((F16X48[buf[n]][num2 + k] << num3) & 0x80);
				}
				OLED_Refresh(main_cache);
			}
		}
		printf("%d, %d,%d\n", (int)n, (int)buf[0], (int)last_buf[0]);
		last_buf[n] = buf[n];
		printf("%d, %d,%d\n", (int)n, (int)buf[0], (int)last_buf[0]);
	}
}