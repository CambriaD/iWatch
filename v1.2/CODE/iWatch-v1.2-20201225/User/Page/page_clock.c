#include "GUI_PAGE.h"
#include "Sys.h"

extern unsigned char xdata main_cache[];
extern unsigned char xdata sub_cache[];

static PageExecuteRate_TypeDef Rate_50hz = {20, 0};

static unsigned char code Text[] = "CLOCK";
static unsigned char code Icon[] = {
0x00,0x00,0x80,0xC0,0xE0,0xE0,0xF0,0x70,0x38,0x3C,0x1C,0x1E,0x0E,0x0E,0x80,0x80,
0xC0,0xC0,0xC0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0x80,
0x80,0x00,0x0E,0x0E,0x1E,0x1C,0x38,0x38,0x70,0xF0,0xE0,0xC0,0xC0,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x01,0x00,0xC0,0xE0,0xF8,0x7C,0x1C,0x0E,0x0F,0x07,0x03,0x03,
0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,
0x03,0x07,0x0F,0x1E,0x3C,0x78,0xF0,0xE0,0x80,0x00,0x00,0x01,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xF8,0xFF,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
0x0E,0x1C,0x38,0x70,0xE0,0xC0,0x80,0x80,0xC0,0xE0,0x70,0x38,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x7F,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0x7F,0xFF,0xF8,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFC,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x03,0x0F,0x1F,0x3E,0x78,0xF0,0xE0,0xC0,0x80,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0x80,0xC0,0xE0,0xF0,0x78,0x3E,0x1F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x23,0x3F,0x3F,0x0F,
0x06,0x0E,0x0E,0x0E,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x0E,0x0E,0x0E,0x07,0x07,
0x0F,0x3F,0x3F,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
/* (48 X 48 )*/
};
static unsigned char code SETTIME[] = {//设定时间/日期
	0x40,0x40,0x42,0xCC,0x00,0x40,0xA0,0x9E,0x82,0x82,0x82,0x9E,0xA0,0x20,0x20,0x00,
	0x10,0x0C,0x44,0x44,0x44,0x44,0x45,0xC6,0x44,0x44,0x44,0x44,0x44,0x14,0x0C,0x00,
	0x00,0xFC,0x84,0x84,0x84,0xFC,0x00,0x10,0x10,0x10,0x10,0x10,0xFF,0x10,0x10,0x00,
	0x00,0xF8,0x01,0x06,0x00,0xF0,0x12,0x12,0x12,0xF2,0x02,0x02,0x02,0xFE,0x00,0x00,
	0x00,0x00,0x00,0x00,0xC0,0x38,0x04,0x00,0x00,0x00,0x00,0xFE,0x82,0x82,0x82,0x82,
	0x82,0x82,0x82,0xFE,0x00,0x00,0x00,0x00,0x00,0x04,0xFF,0x24,0x24,0x24,0xFF,0x04,
	0x00,0xFE,0x22,0x22,0x22,0xFE,0x00,0x00,0x00,0x00,0x00,0x3F,0x90,0x88,0x40,0x43,
	0x2C,0x10,0x28,0x46,0x41,0x80,0x80,0x00,0x80,0x40,0x20,0x1E,0x20,0x40,0x40,0x7F,
	0x44,0x44,0x44,0x44,0x44,0x40,0x40,0x00,0x00,0x3F,0x10,0x10,0x10,0x3F,0x00,0x00,
	0x01,0x06,0x40,0x80,0x7F,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x1F,0x11,0x11,
	0x11,0x1F,0x00,0x40,0x80,0x7F,0x00,0x00,0x00,0x60,0x18,0x07,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0xFF,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0xFF,0x00,0x00,0x00,0x00,
	0x88,0x48,0x2F,0x09,0x09,0x19,0xAF,0x48,0x30,0x0F,0x02,0x42,0x82,0x7F,0x00,0x00
	/* (104 X 16 )*/
};
static unsigned char code SETALARM[] = {//设定闹钟
	0x40,0x40,0x42,0xCC,0x00,0x40,0xA0,0x9E,0x82,0x82,0x82,0x9E,0xA0,0x20,0x20,0x00,
	0x10,0x0C,0x44,0x44,0x44,0x44,0x45,0xC6,0x44,0x44,0x44,0x44,0x44,0x14,0x0C,0x00,
	0x00,0xF8,0x01,0x22,0x20,0x22,0x2A,0xF2,0x22,0x22,0x22,0x22,0x02,0xFE,0x00,0x00,
	0x20,0x10,0x2C,0xE7,0x24,0x24,0x00,0xF0,0x10,0x10,0xFF,0x10,0x10,0xF0,0x00,0x00,
	0x00,0x00,0x00,0x3F,0x90,0x88,0x40,0x43,0x2C,0x10,0x28,0x46,0x41,0x80,0x80,0x00,
	0x80,0x40,0x20,0x1E,0x20,0x40,0x40,0x7F,0x44,0x44,0x44,0x44,0x44,0x40,0x40,0x00,
	0x00,0xFF,0x00,0x00,0x1F,0x01,0x01,0x7F,0x09,0x11,0x0F,0x40,0x80,0x7F,0x00,0x00,
	0x01,0x01,0x01,0x7F,0x21,0x11,0x00,0x07,0x02,0x02,0xFF,0x02,0x02,0x07,0x00,0x00
	/* (64 X 16 )*/
};

extern struct pcf8563_time RTC;		//时间信息结构体
extern unsigned char code WEEKDAY_IN_STR[7][6];
typedef struct {
	unsigned char *value;						//被设置的值的指针
	unsigned char value_max;					//NUM设置类型的数值最大值
	unsigned char value_min;					//NUM设置类型的数值最小值
}Setting_TypeDef;
static Setting_TypeDef setting_parameter[3][4] = {
	{
		{0, 24, 255},
		{0, 60, 255},
		{0, 60, 255},
		{0}
	},
	{
		{0, 99, 0},
		{0, 13, 0},
		{0, 31, 0},
		{0, 8, 0}
	},
	{
		{0, 24, 255},
		{0, 60, 255},
		{0, 5, 255},
		{0}
	}
};
#define	SELECTING	0
#define	SETTING		1
static unsigned char mode = SELECTING;
#define	SET_TIME		0
#define	SET_DATE		1
#define	SET_ALARM		2
static unsigned char mode_setting = SET_TIME;
#define	SET_HOUR		0
#define	SET_MIN			1
#define	SET_SEC			2
#define	SET_YEAR		0
#define	SET_MONTH		1
#define	SET_DAY			2
#define	SET_WEEKDAY	3
#define	SET_ALARM_HOUR	0
#define	SET_ALARM_MIN		1
#define	SET_ALARM_MODE	2
static unsigned char mode_setindex = 0;
static unsigned char alarm_hour = 0;
static unsigned char alarm_min = 0;
static unsigned char alarm_mode = 0;

/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup()
{
	setting_parameter[SET_TIME][SET_HOUR].value = &RTC.hour;
	setting_parameter[SET_TIME][SET_MIN].value = &RTC.minute;
	setting_parameter[SET_TIME][SET_SEC].value = &RTC.second;
	setting_parameter[SET_DATE][SET_YEAR].value = &RTC.year;
	setting_parameter[SET_DATE][SET_MONTH].value = &RTC.month;
	setting_parameter[SET_DATE][SET_DAY].value = &RTC.day;
	setting_parameter[SET_DATE][SET_WEEKDAY].value = &RTC.weekday;
	setting_parameter[SET_ALARM][SET_ALARM_HOUR].value = &alarm_hour;
	setting_parameter[SET_ALARM][SET_ALARM_MIN].value = &alarm_min;
	setting_parameter[SET_ALARM][SET_ALARM_MODE].value = &alarm_mode;
	ClearCache(sub_cache);
	BMPToCache(8, 0, 104, 16, SETTIME, sub_cache, COVER);
	BMPToCache(8, 4, 64, 16, SETALARM, sub_cache, COVER);
	PageOpenAnim(2);
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit()
{
	PageCloseAnim(3);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	unsigned char str[12];
	if(PageExecuteRate(&Rate_50hz) == 1)
	{
		ClearCache(main_cache);
		BMPToCache(8, 0, 104, 16, SETTIME, main_cache, COVER);
		BMPToCache(8, 4, 64, 16, SETALARM, main_cache, COVER);
		ShowString(0, ((mode_setting==2)?6:(mode_setting==0?2:3)), ">", main_cache, FONT6X8, NO_INVERSED);
		if(mode == SELECTING)
		{
			sprintf(str, "%02d:%02d:%02d", (int)RTC.hour, (int)RTC.minute, (int)RTC.second);
			ShowString(6, 2, str, main_cache, FONT6X8, NO_INVERSED);
			sprintf(str, "%d/%2d/%2d", (int)RTC.year + 2000, (int)RTC.month, (int)RTC.day);
			ShowString(6, 3, str, main_cache, FONT6X8, NO_INVERSED);
			ShowString(78, 3, WEEKDAY_IN_STR[RTC.weekday - 1], main_cache, FONT6X8, NO_INVERSED);
		}
		else if(mode == SETTING)
		{
			if(mode_setting == 0)
			{
				sprintf(str, "%d/%2d/%2d", (int)RTC.year + 2000, (int)RTC.month, (int)RTC.day);
				ShowString(6, 3, str, main_cache, FONT6X8, NO_INVERSED);
				ShowString(78, 3, WEEKDAY_IN_STR[RTC.weekday - 1], main_cache, FONT6X8, NO_INVERSED);
				//设定时间
				ShowString(6, 2, "  :  :  ", main_cache, FONT6X8, NO_INVERSED);
				sprintf(str, "%02d", (int)RTC.hour);
				ShowString(6, 2, str, main_cache, FONT6X8, mode_setindex == 0?INVERSED:NO_INVERSED);
				sprintf(str, "%02d", (int)RTC.minute);
				ShowString(24, 2, str, main_cache, FONT6X8, mode_setindex == 1?INVERSED:NO_INVERSED);
				sprintf(str, "%02d", (int)RTC.second);
				ShowString(42, 2, str, main_cache, FONT6X8, mode_setindex == 2?INVERSED:NO_INVERSED);
				
			}
			else if(mode_setting == 1)
			{
				sprintf(str, "%02d:%02d:%02d", (int)RTC.hour, (int)RTC.minute, (int)RTC.second);
				ShowString(6, 2, str, main_cache, FONT6X8, NO_INVERSED);
				//设定日期
				ShowString(6, 3, "    /  /  ", main_cache, FONT6X8, NO_INVERSED);
				sprintf(str, "%d", (int)RTC.year + 2000);
				ShowString(6, 3, str, main_cache, FONT6X8, mode_setindex == 0?INVERSED:NO_INVERSED);
				sprintf(str, "%2d", (int)RTC.month);
				ShowString(36, 3, str, main_cache, FONT6X8, mode_setindex == 1?INVERSED:NO_INVERSED);
				sprintf(str, "%2d", (int)RTC.day);
				ShowString(54, 3, str, main_cache, FONT6X8, mode_setindex == 2?INVERSED:NO_INVERSED);
				ShowString(78, 3, WEEKDAY_IN_STR[RTC.weekday - 1], main_cache, FONT6X8, mode_setindex == 3?INVERSED:NO_INVERSED);
			}
		}
		ScreenRefreshAll(main_cache);
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(mode == SELECTING)
	{
		if(event == KEY1)
			PageShift(page_menu);
		else if(event == KEY2)
		{
			if(--mode_setting == 255)
				mode_setting = 2;
		}
		else if(event == KEY3)
		{
			if(++mode_setting == 3)
				mode_setting = 0;
		}
		else if(event == DOUBLE_TAP)
		{
			mode = SETTING;
			mode_setindex = 0;
		}
	}
	else if(mode == SETTING)
	{
		if(event == KEY1)
		{
			mode = SELECTING;
			PCF8563WriteTime(RTC.hour, RTC.minute, RTC.second);
			PCF8563WriteDate(RTC.year, RTC.month, RTC.day, RTC.weekday);
		}
		if(event == KEY2)
		{
			if(++*setting_parameter[mode_setting][mode_setindex].value == setting_parameter[mode_setting][mode_setindex].value_max)
				*setting_parameter[mode_setting][mode_setindex].value = setting_parameter[mode_setting][mode_setindex].value_min + 1;
		}
		else if(event == KEY3)
		{
			if(--*setting_parameter[mode_setting][mode_setindex].value == setting_parameter[mode_setting][mode_setindex].value_min)
				*setting_parameter[mode_setting][mode_setindex].value = setting_parameter[mode_setting][mode_setindex].value_max - 1;
		}
		else if(event == DOUBLE_TAP)
		{
			if(mode_setting == 0)
			{
				if(++mode_setindex == 3)
					mode_setindex = 0;
			}
			else if(mode_setting == 1)
			{
				if(++mode_setindex == 4)
					mode_setindex = 0;
			}
		}
	}
}

void PageRegister_page_clock(unsigned char pageID)
{
	PageRegister(pageID, Text, Icon, Setup, Loop, Exit, Event);
}