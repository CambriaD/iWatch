#include "iWatch.h"

extern unsigned char xdata main_cache[];
extern unsigned char xdata sub_cache[];

static PageExecuteRate_TypeDef Rate_50hz = {20, 0};
static PageExecuteRate_TypeDef Rate_125hz = {8,0};

static unsigned char code Text[] = "COMPASS";
static unsigned char code Icon[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x30,0x18,0x18,0x0C,0x0C,
0x0C,0x06,0x06,0x06,0x06,0x06,0x03,0xF3,0xF3,0x03,0x06,0x06,0x06,0x06,0x06,0x0C,
0x0C,0x1C,0x18,0x38,0x30,0x70,0xE0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xC0,0xF0,0x3C,0x0E,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x80,0x80,0xC0,0xC0,
0xE0,0xE0,0xF0,0x30,0x00,0x00,0x00,0x01,0x03,0x07,0x1E,0x7C,0xF0,0xC0,0x00,0x00,
0xF0,0xFF,0x1F,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x80,0xC0,0xF0,0x70,0x78,0xFC,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0x7F,0x3F,
0x0F,0x03,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x01,0x3F,0xFE,0xC0,
0x0F,0xFF,0xF8,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0xC0,0xF0,
0x7C,0x1E,0x8F,0xC3,0xC0,0x60,0x70,0x30,0x39,0x1F,0x0F,0x07,0x03,0x01,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x80,0xFC,0x7F,0x0F,
0x00,0x00,0x03,0x0F,0x3C,0x70,0xE0,0xC0,0x80,0x00,0x00,0x08,0x0C,0x0F,0x07,0x07,
0x03,0x03,0x01,0x01,0x00,0x00,0x00,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0x78,0x3E,0x0F,0x03,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0E,0x0C,0x18,0x18,0x30,0x30,
0x70,0x60,0x60,0x60,0x60,0x60,0xC0,0xCF,0xCF,0xC0,0x60,0x60,0x60,0x60,0x60,0x30,
0x30,0x30,0x18,0x1C,0x0C,0x0E,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00
/* (48 X 48 )*/
};

const unsigned char code COMPASS_ICON[512] = {//64x64指南针界面的罗盘图像
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x80,0x80,0xC0,0x40,0x60,0x60,0x20,0x00,0x00,0x00,0xFF,0x0C,0x18,
	0x60,0xC0,0xFF,0x00,0x00,0x00,0x20,0x60,0x60,0x40,0xC0,0xC0,0x80,0x80,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x30,0x18,0x0C,0x06,
	0x06,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,
	0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x06,
	0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0x38,0x0E,0x03,0x01,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0E,0x3C,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x18,0xF0,0x00,0x80,0xFB,0xF1,0x00,0xC0,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x99,0x8B,0x88,0x08,0x08,0x00,0x00,
	0x00,0x00,0x01,0x0F,0x0F,0xC0,0x81,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x98,0xD8,0x18,0x18,0x18,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x3C,0x70,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0x3C,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x06,0x0C,0x18,0x30,0x60,
	0x60,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x40,0x40,
	0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xC0,
	0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x01,0x01,0x03,0x03,0x02,0x06,0x06,0x04,0x00,0x00,0x00,0x23,0x42,0x46,
	0x44,0x6C,0x38,0x00,0x00,0x00,0x04,0x06,0x06,0x06,0x03,0x03,0x01,0x01,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const unsigned char code NESW[8][64] = {//32x16指南针界面的中文
	{	//北
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x20,0x20,0xFE,0x00,0x00,
		0x00,0xFE,0x80,0x40,0x20,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x10,0x08,0x04,0x7F,0x00,0x00,
		0x00,0x3F,0x40,0x40,0x40,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{	//西北
		0x00,0x00,0x08,0xC8,0xA8,0x98,0x8E,0xE8,0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x00,
		0x00,0x20,0x20,0x20,0x20,0xFE,0x00,0x00,0x00,0xFE,0x80,0x40,0x20,0x10,0x00,0x00,
		0x00,0x20,0x10,0x0C,0x00,0x40,0x40,0x7F,0x00,0x00,0x04,0x08,0x30,0x00,0x00,0x00,
		0x00,0x10,0x10,0x08,0x04,0x7F,0x00,0x00,0x00,0x3F,0x40,0x40,0x40,0x70,0x00,0x00
	},
	{	//西
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0xC8,0xA8,0x98,0x8E,0xE8,
		0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x10,0x0C,0x00,0x40,0x40,0x7F,
		0x00,0x00,0x04,0x08,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{	//西南
		0x00,0x00,0x08,0xC8,0xA8,0x98,0x8E,0xE8,0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x00,
		0x00,0x08,0xE8,0x28,0x28,0x68,0xA8,0x3E,0xA8,0x68,0x28,0x28,0xE8,0x08,0x00,0x00,
		0x00,0x20,0x10,0x0C,0x00,0x40,0x40,0x7F,0x00,0x00,0x04,0x08,0x30,0x00,0x00,0x00,
		0x00,0x00,0x7F,0x04,0x05,0x05,0x05,0x3F,0x05,0x05,0x45,0x44,0x7F,0x00,0x00,0x00
	},
	{	//南
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0xE8,0x28,0x28,0x68,0xA8,0x3E,
		0xA8,0x68,0x28,0x28,0xE8,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x04,0x05,0x05,0x05,0x3F,
		0x05,0x05,0x45,0x44,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{	//东南
		0x00,0x04,0xE4,0x24,0x24,0xFC,0x24,0x24,0x24,0xFC,0x24,0x24,0xE4,0x04,0x00,0x00,
		0x00,0x08,0xE8,0x28,0x28,0x68,0xA8,0x3E,0xA8,0x68,0x28,0x28,0xE8,0x08,0x00,0x00,
		0x00,0x00,0x7F,0x28,0x24,0x23,0x20,0x20,0x20,0x23,0x24,0x24,0x7F,0x00,0x00,0x00,
		0x00,0x00,0x7F,0x04,0x05,0x05,0x05,0x3F,0x05,0x05,0x45,0x44,0x7F,0x00,0x00,0x00
	},
	{	//东
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xE4,0x24,0x24,0xFC,0x24,0x24,
		0x24,0xFC,0x24,0x24,0xE4,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x28,0x24,0x23,0x20,0x20,
		0x20,0x23,0x24,0x24,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{	//东北
		0x00,0x04,0xE4,0x24,0x24,0xFC,0x24,0x24,0x24,0xFC,0x24,0x24,0xE4,0x04,0x00,0x00,
		0x00,0x20,0x20,0x20,0x20,0xFE,0x00,0x00,0x00,0xFE,0x80,0x40,0x20,0x10,0x00,0x00,
		0x00,0x00,0x7F,0x28,0x24,0x23,0x20,0x20,0x20,0x23,0x24,0x24,0x7F,0x00,0x00,0x00,
		0x00,0x10,0x10,0x08,0x04,0x7F,0x00,0x00,0x00,0x3F,0x40,0x40,0x40,0x70,0x00,0x00
	}
};
static char mode = 0;
int magnet_data[3] = {0};
static unsigned char str[16];
extern iWatch_config config;		//设置信息结构体
extern struct lsm6dsm_data LSM6DSM;	//LSM6DSM数据结构体
/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup()
{
	ClearCache(sub_cache);
	ShowString(24, 4, str, sub_cache, FONT8X16, NO_INVERSED);
	BMPToCache(64, 0, 64, 64, COMPASS_ICON, sub_cache, COVER);
	PageOpenAnim(ANIM_RIGHT);
	LSM6DSMConfigAcc(ACC_ODR_208_HZ, ACC_SCALE_4_G);
	LSM6DSMConfigGyr(ACC_ODR_208_HZ, GYR_SCALE_500_DPS);
	LIS3MDL_Set_Mode(0);  									//设置连续测量模式
	LIS3MDL_Set_Calibration_Value(config.cal_magnet_x0, config.cal_magnet_y0, config.cal_magnet_z0, 
																config.cal_magnet_ab, config.cal_magnet_ac);	//设置校准参数
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit()
{
	LIS3MDL_Set_Mode(2);
	LSM6DSMConfigAcc(ACC_ODR_416_HZ, ACC_SCALE_4_G);
	LSM6DSMConfigGyr(GYR_POWER_DOWN, GYR_SCALE_500_DPS);
	PageCloseAnim(ANIM_RIGHT);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	if(PageExecuteRate(&Rate_125hz) == 1)
	{
		LSM6DSMReadGYRAndACC(&LSM6DSM);
		IMUupdate(&LSM6DSM);
	}
	if(PageExecuteRate(&Rate_50hz) == 1)
	{
		unsigned char n;
		float angle_from_north;
		Read_LIS3MDL(magnet_data);
		angle_from_north = LIS3MDL_Get_AngleXY(magnet_data, (int)LSM6DSM.AngleX, (int)LSM6DSM.AngleY) * 0.2 + angle_from_north * 0.8;
		angle_from_north += 90;
		if(angle_from_north >= 360)
						angle_from_north -= 360;
		n = (angle_from_north + 22.5) / 45;
		if(n == 8)
			n = 0;
		ClearCache(main_cache);
		BMPToCache(16, 2, 32, 16, NESW[n], main_cache, 0);
		sprintf(str, "%d  ", (int)angle_from_north);
		ShowString(24, 4, str, main_cache, FONT8X16, NO_INVERSED);
		BMPToCache(64, 0, 64, 64, COMPASS_ICON, main_cache, 0);
		angle_from_north -= 90;
		if(angle_from_north < 0)
			angle_from_north += 360;
		DrawArm(95, 31, 18, (int)angle_from_north);
		ScreenRefreshAll(main_cache);
	}
}
/**
  * @brief  页面事件
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY1)
		PageShift(page_menu);
	else if(event == KEY2)
		PageShift(page_mag_cal);
}

void PageRegister_page_compass(unsigned char pageID)
{
	PageRegister(pageID, Text, Icon, Setup, Loop, Exit, Event);
}